<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- PWA Support -->
  <meta name="theme-color" content="#0d1117">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <title>ScheduleOS - Tambah/Edit Jadwal</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --border-primary: #30363d;
      --border-secondary: #21262d;
      --text-primary: #c9d1d9;
      --text-secondary: #8b949e;
      --accent-blue: #58a6ff;
      --accent-green: #238636;
      --accent-green-hover: #2ea043;
      --accent-red: #f85149;
      --accent-orange: #f78166;
      --shadow: rgba(0, 0, 0, 0.3);
      --focus-glow: rgba(88, 166, 255, 0.25);
    }

    body {
      background: linear-gradient(135deg, var(--bg-primary) 0%, #010409 100%);
      color: var(--text-primary);
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Fira Code', Consolas, 'Courier New', monospace;
      min-height: 100vh;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 20%, rgba(88, 166, 255, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(35, 134, 54, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .back-link {
      position: absolute;
      top: 20px;
      left: 20px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--accent-blue);
      text-decoration: none;
      padding: 8px 16px;
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      background: var(--bg-secondary);
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .back-link:hover {
      background: var(--bg-tertiary);
      transform: translateX(-2px);
    }

    .form-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 16px 64px var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .form-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
    }

    .form-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .terminal-prompt {
      color: var(--accent-green);
      font-size: 0.9rem;
      margin-bottom: 15px;
    }

    .form-title {
      color: var(--accent-blue);
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .form-subtitle {
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-label {
      display: block;
      color: var(--text-primary);
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    .form-label::before {
      content: '> ';
      color: var(--accent-green);
      font-weight: 700;
    }

    .form-control {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-primary);
      border: 2px solid var(--border-primary);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 4px var(--focus-glow);
      background: var(--bg-secondary);
    }

    .form-control::placeholder {
      color: var(--text-secondary);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .btn-container {
      margin-top: 40px;
      display: flex;
      gap: 15px;
    }

    .btn {
      flex: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 16px 24px;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-size: 1.1rem;
      font-weight: 700;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-green), var(--accent-green-hover));
      color: white;
      border: 2px solid var(--accent-green);
      box-shadow: 0 4px 16px rgba(35, 134, 54, 0.2);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(35, 134, 54, 0.4);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 2px solid var(--border-primary);
    }

    .btn-secondary:hover {
      background: var(--border-primary);
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Loading Animation */
    .btn-loading {
      position: relative;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      margin: auto;
      border: 2px solid transparent;
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Success/Error Messages */
    .message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 600;
      display: none;
    }

    .message.success {
      background: rgba(35, 134, 54, 0.2);
      border: 1px solid var(--accent-green);
      color: #3fb950;
    }

    .message.error {
      background: rgba(248, 81, 73, 0.2);
      border: 1px solid var(--accent-red);
      color: #ff7b72;
    }

    /* Enhanced Loading Animations */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(13, 17, 23, 0.95);
      backdrop-filter: blur(12px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
      gap: 25px;
    }

    .loading-overlay.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .loading-spinner {
      width: 80px;
      height: 80px;
      border: 4px solid var(--border-primary);
      border-top: 4px solid var(--accent-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-code {
      font-family: 'SF Mono', monospace;
      color: var(--accent-green);
      font-size: 1rem;
      text-align: center;
      line-height: 1.6;
    }

    .loading-progress {
      width: 200px;
      height: 4px;
      background: var(--border-primary);
      border-radius: 2px;
      overflow: hidden;
    }

    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
      width: 0%;
      border-radius: 2px;
      animation: progress 2s ease-in-out infinite;
    }

    @keyframes progress {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }

    .loading-text {
      color: var(--text-secondary);
      font-size: 1.1rem;
      font-weight: 600;
      text-align: center;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    /* Comprehensive Responsive Design */
    
    /* Extra Small Devices (phones, 0-575px) */
    @media (max-width: 575.98px) {
      .container {
        padding: 10px;
        min-height: auto;
        justify-content: flex-start;
        padding-top: 80px;
      }

      .back-link {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 1000;
        padding: 6px 12px;
        font-size: 0.8rem;
      }

      .form-card {
        padding: 20px 15px;
        margin: 0;
        border-radius: 12px;
      }

      .form-title {
        font-size: 1.4rem;
        flex-direction: column;
        gap: 8px;
      }

      .form-subtitle {
        font-size: 0.9rem;
      }

      .terminal-prompt {
        font-size: 0.7rem;
        word-break: break-all;
      }

      .form-row {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .form-control {
        padding: 12px 14px;
        font-size: 16px; /* Prevent zoom on iOS */
      }

      .btn-container {
        margin-top: 30px;
        flex-direction: column;
        gap: 12px;
      }

      .btn {
        padding: 14px 20px;
        font-size: 1rem;
      }

      .loading-overlay {
        gap: 20px;
      }

      .loading-spinner {
        width: 60px;
        height: 60px;
      }

      .loading-code {
        font-size: 0.8rem;
        padding: 0 20px;
      }

      .loading-progress {
        width: 150px;
      }
    }

    /* Small Devices (tablets, 576-767px) */
    @media (min-width: 576px) and (max-width: 767.98px) {
      .container {
        padding: 15px;
        padding-top: 80px;
      }

      .form-card {
        padding: 30px 25px;
      }

      .form-title {
        font-size: 1.6rem;
      }

      .form-row {
        gap: 18px;
      }

      .form-control {
        padding: 13px 15px;
      }

      .btn {
        padding: 15px 22px;
        font-size: 1rem;
      }
    }

    /* Medium Devices (tablets, 768-991px) */
    @media (min-width: 768px) and (max-width: 991.98px) {
      .container {
        padding: 20px;
        max-width: 700px;
      }

      .form-card {
        padding: 35px;
      }

      .form-title {
        font-size: 1.8rem;
      }
    }

    /* Large Devices (desktops, 992-1199px) */
    @media (min-width: 992px) and (max-width: 1199.98px) {
      .container {
        max-width: 750px;
      }

      .form-title {
        font-size: 2rem;
      }
    }

    /* Extra Large Devices (1200px+) */
    @media (min-width: 1200px) {
      .container {
        max-width: 800px;
      }

      .form-title {
        font-size: 2.2rem;
      }

      .form-card {
        padding: 45px;
      }
    }

    /* Landscape Orientation for Small Devices */
    @media (max-height: 500px) and (orientation: landscape) {
      .container {
        padding-top: 20px;
        min-height: auto;
      }

      .form-header {
        margin-bottom: 25px;
      }

      .form-title {
        font-size: 1.2rem;
      }

      .form-subtitle {
        font-size: 0.9rem;
      }

      .terminal-prompt {
        font-size: 0.7rem;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .btn-container {
        margin-top: 25px;
      }

      .back-link {
        top: 5px;
        left: 5px;
        padding: 4px 10px;
        font-size: 0.7rem;
      }
    }

    /* Touch Device Optimizations */
    @media (hover: none) and (pointer: coarse) {
      .form-control {
        min-height: 44px; /* iOS accessibility guidelines */
      }

      .btn {
        min-height: 44px;
      }

      .back-link {
        min-height: 44px;
        display: flex;
        align-items: center;
      }
    }

    /* High DPI Displays */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      .form-card {
        border-width: 0.5px;
      }

      .form-control {
        border-width: 1.5px;
      }
    }

    /* Reduced Motion */
    @media (prefers-reduced-motion: reduce) {
      .loading-spinner {
        animation: none;
        border-top-color: var(--accent-green);
      }

      .loading-progress-bar {
        animation: none;
        width: 70%;
      }

      .loading-text {
        animation: none;
        opacity: 1;
      }

      .btn, .form-control, .back-link {
        transition: none;
      }
    }

    /* Focus Management for Accessibility */
    .form-control:focus-visible {
      outline: 2px solid var(--accent-blue);
      outline-offset: 2px;
    }

    .btn:focus-visible {
      outline: 2px solid var(--accent-blue);
      outline-offset: 2px;
    }

    /* Loading states for form elements */
    .form-disabled {
      opacity: 0.6;
      pointer-events: none;
    }

    .form-control:disabled {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      cursor: not-allowed;
    }

    /* Success/Error Animation */
    .message.show {
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Code-like styling for time inputs */
    input[type="time"] {
      font-family: 'SF Mono', monospace;
      letter-spacing: 1px;
    }

    /* Select dropdown styling */
    select {
      cursor: pointer;
    }

    select option {
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    /* Focus indicators */
    .form-control:focus + .form-label::before {
      color: var(--accent-blue);
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-code" id="loadingCode">
      > Connecting to Firebase...<br>
      > Validating data...<br>
      > <span style="color: var(--accent-blue);">Processing request...</span>
    </div>
    <div class="loading-progress">
      <div class="loading-progress-bar"></div>
    </div>
    <div class="loading-text" id="loadingText">Menyimpan jadwal...</div>
  </div>

  <a href="index.html" class="back-link">
    <span>←</span>
    Kembali ke Dashboard
  </a>

  <div class="container">
    <div class="form-card">
      <div class="form-header">
        <div class="terminal-prompt">user@scheduleos:~$ ./add_schedule --interactive</div>
        <h1 class="form-title">
          <span>⚡</span>
          <span id="formTitle">Tambah Jadwal</span>
        </h1>
        <p class="form-subtitle">Sistem Manajemen Jadwal Kuliah</p>
      </div>

      <div id="message" class="message"></div>

      <form id="jadwalForm">
        <div class="form-group">
          <label for="hari" class="form-label">Hari</label>
          <select id="hari" class="form-control" required>
            <option value="">-- Pilih Hari --</option>
            <option value="Senin">Senin</option>
            <option value="Selasa">Selasa</option>
            <option value="Rabu">Rabu</option>
            <option value="Kamis">Kamis</option>
            <option value="Jumat">Jumat</option>
            <option value="Sabtu">Sabtu</option>
          </select>
        </div>

        <div class="form-group">
          <label for="matkul" class="form-label">Mata Kuliah</label>
          <input type="text" id="matkul" class="form-control" placeholder="Contoh: Pemrograman Web" required>
        </div>

        <div class="form-group">
          <label for="dosen" class="form-label">Dosen</label>
          <input type="text" id="dosen" class="form-control" placeholder="Nama lengkap dosen pengajar" required>
        </div>

        <div class="form-group">
          <label for="ruang" class="form-label">Ruang Kelas</label>
          <input type="text" id="ruang" class="form-control" placeholder="Contoh: Lab 301, B101, Online">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="waktu_masuk" class="form-label">Waktu Masuk</label>
            <input type="time" id="waktu_masuk" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="waktu_keluar" class="form-label">Waktu Keluar</label>
            <input type="time" id="waktu_keluar" class="form-control" required>
          </div>
        </div>

        <div class="btn-container">
          <a href="index.html" class="btn btn-secondary">
            <span>✖️</span>
            Batal
          </a>
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <span>💾</span>
            <span id="submitText">Simpan Jadwal</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="env.js"></script>
  <script type="module" src="firebase.js"></script>
  <script type="module">
    import { db } from "./firebase.js";
    import { 
      collection, 
      addDoc, 
      doc, 
      getDoc, 
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const form = document.getElementById("jadwalForm");
    const submitBtn = document.getElementById("submitBtn");
    const submitText = document.getElementById("submitText");
    const formTitle = document.getElementById("formTitle");
    const message = document.getElementById("message");
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    // Update UI for edit mode
    if (id) {
      formTitle.textContent = "Edit Jadwal";
      submitText.textContent = "Update Jadwal";
      document.querySelector(".terminal-prompt").textContent = "user@scheduleos:~$ ./edit_schedule --id=" + id;
    }

    // Load data for edit mode
    if (id) {
      showMessage("Memuat data jadwal...", "info");
      (async () => {
        try {
          const docRef = doc(db, "jadwal", id);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById("hari").value = data.hari;
            document.getElementById("matkul").value = data.matkul;
            document.getElementById("dosen").value = data.dosen;
            document.getElementById("ruang").value = data.ruang || '';
            document.getElementById("waktu_masuk").value = data.waktu_masuk || '';
            document.getElementById("waktu_keluar").value = data.waktu_keluar || '';
            hideMessage();
          } else {
            showMessage("Jadwal tidak ditemukan!", "error");
          }
        } catch (error) {
          console.error("Error loading data:", error);
          showMessage("Error memuat data: " + error.message, "error");
        }
      })();
    }

    // Form submission
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      // Validate time inputs
      const waktuMasuk = document.getElementById("waktu_masuk").value;
      const waktuKeluar = document.getElementById("waktu_keluar").value;
      
      if (waktuMasuk >= waktuKeluar) {
        showMessage("Waktu keluar harus lebih besar dari waktu masuk!", "error");
        return;
      }
      
      // Show loading state
      setLoading(true);
      
      const data = {
        hari: document.getElementById("hari").value,
        matkul: document.getElementById("matkul").value,
        dosen: document.getElementById("dosen").value,
        ruang: document.getElementById("ruang").value || 'Tidak disebutkan',
        waktu_masuk: waktuMasuk,
        waktu_keluar: waktuKeluar,
        created_at: id ? undefined : new Date().toISOString(),
        updated_at: new Date().toISOString()
      };
      
      // Remove undefined values for update
      if (id) {
        delete data.created_at;
      }
      
      try {
        if (id) {
          await updateDoc(doc(db, "jadwal", id), data);
          showMessage("✅ Jadwal berhasil diperbarui!", "success");
        } else {
          await addDoc(collection(db, "jadwal"), data);
          showMessage("✅ Jadwal berhasil ditambahkan!", "success");
        }
        
        // Redirect after 1.5 seconds
        setTimeout(() => {
          window.location.href = "index.html";
        }, 1500);
        
      } catch (error) {
        console.error("Error saving data:", error);
        showMessage("❌ Error: " + error.message, "error");
        setLoading(false);
      }
    });

    // Helper functions
    function setLoading(loading, text = '') {
      const overlay = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');
      const loadingCode = document.getElementById('loadingCode');
      const form = document.querySelector('.form-card');
      
      if (loading) {
        overlay.classList.add('show');
        form.classList.add('form-disabled');
        loadingText.textContent = text || (id ? 'Menyimpan perubahan...' : 'Menambahkan jadwal...');
        
        // Animate loading code
        const codeSteps = [
          '> Connecting to Firebase...',
          '> Connecting to Firebase... ✓<br>> Validating data...',
          '> Connecting to Firebase... ✓<br>> Validating data... ✓<br>> <span style="color: var(--accent-blue);">Processing request...</span>',
          '> Connecting to Firebase... ✓<br>> Validating data... ✓<br>> Processing request... ✓<br>> <span style="color: var(--accent-green);">Success!</span>'
        ];
        
        let step = 0;
        const codeInterval = setInterval(() => {
          if (step < codeSteps.length) {
            loadingCode.innerHTML = codeSteps[step];
            step++;
          } else {
            clearInterval(codeInterval);
          }
        }, 800);
        
        // Store interval ID for cleanup
        overlay.codeInterval = codeInterval;
        
      } else {
        overlay.classList.remove('show');
        form.classList.remove('form-disabled');
        
        // Clear any running intervals
        if (overlay.codeInterval) {
          clearInterval(overlay.codeInterval);
        }
        
        // Reset code display
        loadingCode.innerHTML = '> Connecting to Firebase...<br>> Validating data...<br>> <span style="color: var(--accent-blue);">Processing request...</span>';
      }
      
      submitBtn.disabled = loading;
      if (loading) {
        submitBtn.classList.add("btn-loading");
        submitText.textContent = id ? "Menyimpan..." : "Menambahkan...";
      } else {
        submitBtn.classList.remove("btn-loading");
        submitText.textContent = id ? "Update Jadwal" : "Simpan Jadwal";
      }
    }

    function showMessage(text, type) {
      message.textContent = text;
      message.className = `message ${type} show`;
      message.style.display = "block";
      
      if (type === "success") {
        setTimeout(hideMessage, 5000);
      }
      
      // Auto-hide after 10 seconds for errors
      if (type === "error") {
        setTimeout(hideMessage, 10000);
      }
    }

    function hideMessage() {
      message.style.display = "none";
      message.classList.remove('show');
    }

    // Form validation with real-time feedback
    function validateForm() {
      const hari = document.getElementById("hari").value;
      const matkul = document.getElementById("matkul").value.trim();
      const dosen = document.getElementById("dosen").value.trim();
      const waktuMasuk = document.getElementById("waktu_masuk").value;
      const waktuKeluar = document.getElementById("waktu_keluar").value;
      
      const errors = [];
      
      if (!hari) errors.push("Hari harus dipilih");
      if (!matkul) errors.push("Mata kuliah harus diisi");
      if (!dosen) errors.push("Nama dosen harus diisi");
      if (!waktuMasuk) errors.push("Waktu masuk harus diisi");
      if (!waktuKeluar) errors.push("Waktu keluar harus diisi");
      
      if (waktuMasuk && waktuKeluar && waktuMasuk >= waktuKeluar) {
        errors.push("Waktu keluar harus lebih besar dari waktu masuk");
      }
      
      return errors;
    }

    // Real-time validation
    const formInputs = document.querySelectorAll('.form-control');
    formInputs.forEach(input => {
      input.addEventListener('blur', () => {
        const errors = validateForm();
        if (errors.length === 0) {
          hideMessage();
        }
      });
    });

    // Enhanced form submission with better UX
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const errors = validateForm();
      if (errors.length > 0) {
        showMessage("❌ " + errors[0], "error");
        return;
      }
      
      // Show loading with custom text
      const loadingText = id ? "Memperbarui jadwal kuliah..." : "Menambahkan jadwal baru...";
      setLoading(true, loadingText);
      
      const data = {
        hari: document.getElementById("hari").value,
        matkul: document.getElementById("matkul").value.trim(),
        dosen: document.getElementById("dosen").value.trim(),
        ruang: document.getElementById("ruang").value.trim() || 'Tidak disebutkan',
        waktu_masuk: document.getElementById("waktu_masuk").value,
        waktu_keluar: document.getElementById("waktu_keluar").value,
        created_at: id ? undefined : new Date().toISOString(),
        updated_at: new Date().toISOString()
      };
      
      // Remove undefined values for update
      if (id) {
        delete data.created_at;
      }
      
      try {
        // Simulate minimum loading time for better UX
        const minLoadingTime = new Promise(resolve => setTimeout(resolve, 2000));
        
        const savePromise = id ? 
          updateDoc(doc(db, "jadwal", id), data) : 
          addDoc(collection(db, "jadwal"), data);
        
        await Promise.all([savePromise, minLoadingTime]);
        
        const successMsg = id ? 
          "✅ Jadwal berhasil diperbarui!" : 
          "✅ Jadwal baru berhasil ditambahkan!";
        
        showMessage(successMsg, "success");
        
        // Redirect after showing success message
        setTimeout(() => {
          window.location.href = "index.html";
        }, 2000);
        
      } catch (error) {
        console.error("Error saving data:", error);
        setLoading(false);
        
        let errorMsg = "❌ Terjadi kesalahan: ";
        if (error.code === 'permission-denied') {
          errorMsg += "Tidak memiliki izin untuk menyimpan data";
        } else if (error.code === 'unavailable') {
          errorMsg += "Layanan tidak tersedia, coba lagi nanti";
        } else {
          errorMsg += error.message;
        }
        
        showMessage(errorMsg, "error");
      }
    });
  </script>
</body>
</html>